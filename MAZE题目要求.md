# MAZE网络芯片题目要求

## 整体要求

1. **网络拓扑**: 64节点的8×8网格网络，每个节点有确定的坐标【x，y】，节点对外呈现A、B、C三组接口：
   - **A接口**: 数据包输入接口（支持反压）
   - **B接口**: 数据包输出接口（支持反压）
   - **C接口**: 节点间拓扑连接接口（**重要：每个节点只例化一个C接口，该接口内部包含4个输入端口和4个输出端口，分别对应NWSE四个方向**）

2. **网络连接**: 所有节点通过拓扑网络间接连接，支持节点间相互通信

3. **数据包路由**: 从任意节点A口输入的数据包，根据pkt_type和pkt_dst字段路由到目标节点的B口输出

4. **模块架构**: 维护三个核心模块：
   - **node**: 网络节点模块（包含路由和仲裁逻辑）
   - **topo**: 拓扑连接模块（只使用IRS模块连接节点）
   - **maze_top**: 顶层模块（实例化64个node和1个topo）

5. **节点连接**: 每个节点与NWSE四个方向的邻居节点相连

6. **拓扑限制**: topo模块只能例化IRS模块进行节点连接，不能包含其他逻辑

7. **IRS深度**: 两节点间IRS深度 = 节点曼哈顿距离 - 1

## 功能要求

### 8. 多播/广播支持
- **多播**: 从A口输入数据包，发送给相同横坐标或相同纵坐标的所有节点
- **广播**: 从A口输入数据包，发送给全部64个节点

### 9-14. 故障容错
- **故障配置**: 支持单个节点失效，由顶层配置pg_en和pg_node（静态信号）
- **时钟门控**: 故障节点通过时钟门控停止工作
- **单播避障**: 单播目标节点不会是故障节点
- **多播容错**: 多播/广播可能包含故障节点，故障节点不输出数据包

### 15-17. 数据包正确性
- **X多播**: B口输出的pkt_tgt中横坐标正确
- **Y多播**: B口输出的pkt_tgt中纵坐标正确
- **广播**: 不要求pkt_tgt正确
- **其他字段**: pkt_type、pkt_qos、pkt_src、pkt_data都必须正确

### 18-20. QoS和时序
- **QoS支持**: 两级优先级（QoS=0低优先级，QoS=1高优先级）
- **坐标格式**: pkt_src和pkt_tgt的[5:3]为纵坐标，[2:0]为横坐标
- **寄存器输出**: 节点所有输出都必须是寄存器输出（包括rdy信号）

## 新架构设计方案

### 节点内部架构（非流水线设计）

```
                ┌─────────────────────────────────────────────────────┐
                │                    MAZE节点                        │
                ├─────────────────────────────────────────────────────┤
                │  输入端口 (5个)                                     │
                │  ├─ A口 (外部输入)    → IRS_N                       │
                │  ├─ C口_N (北方)      → IRS_N                       │
                │  ├─ C口_W (西方)      → IRS_N                       │
                │  ├─ C口_S (南方)      → IRS_N                       │
                │  └─ C口_E (东方)      → IRS_N                       │
                │                                                     │
                │  路由处理层                                         │
                │  ├─ 路由单元_A  → 故障感知XY路由算法                │
                │  ├─ 路由单元_N  → 故障感知XY路由算法                │
                │  ├─ 路由单元_W  → 故障感知XY路由算法                │
                │  ├─ 路由单元_S  → 故障感知XY路由算法                │
                │  └─ 路由单元_E  → 故障感知XY路由算法                │
                │                                                     │
                │  请求生成                                           │
                │  └─ 5个路由单元生成5-bit one-hot请求信号            │
                │                                                     │
                │  输出仲裁 (5个仲裁器)                                │
                │  ├─ 仲裁器_N  → 4输入QoS仲裁                       │
                │  ├─ 仲裁器_W  → 4输入QoS仲裁                       │
                │  ├─ 仲裁器_S  → 4输入QoS仲裁                       │
                │  ├─ 仲裁器_E  → 4输入QoS仲裁                       │
                │  └─ 仲裁器_B  → 4输入QoS仲裁                       │
                │                                                     │
                │  输出端口 (5个)                                     │
                │  ├─ B口 (外部输出)    ← IRS_N (RO_EN=1)             │
                │  ├─ C口_N (北方)      ← IRS_N (RO_EN=1)             │
                │  ├─ C口_W (西方)      ← IRS_N (RO_EN=1)             │
                │  ├─ C口_S (南方)      ← IRS_N (RO_EN=1)             │
                │  └─ C口_E (东方)      ← IRS_N (RO_EN=1)             │
                └─────────────────────────────────────────────────────┘
```

### 处理流程

1. **输入缓冲**: A口和4个C口(NWSE)的数据包进入各自的IRS_N缓存

2. **独立路由**: 5个路由单元并行处理，每个基于故障感知的XY路由算法计算输出方向

3. **请求生成**: 每个路由单元生成5-bit one-hot请求信号，指向5个输出端口之一

4. **QoS仲裁**: 5个仲裁器并行工作，每个处理4个输入请求，高QoS获得绝对优先权

5. **输出缓冲**: 仲裁胜出的数据包进入对应输出端口的IRS_N(RO_EN=1)

6. **拓扑传输**: NWSE输出通过IRS_N传输到相邻节点

### 关键优势

- **低延迟**: 2时钟周期总延迟（1周期路由 + 1周期仲裁）
- **高吞吐量**: 并行处理，每周期最多处理5个输入数据包
- **容错性强**: 智能故障感知路由算法
- **设计简洁**: 相比流水线架构减少硬件复杂度

### 路由算法特性

- **故障感知**: 根据故障节点相对位置动态选择路径
- **XY路由**: 优先X方向，次选Y方向
- **绕行策略**: 支持8个故障区域的智能绕行
- **静态配置**: 故障信息预先配置到所有节点
